name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DEPLOY_PATH: /srv/apps/Iot-Monitoring

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy on server (git pull + docker compose)
        run: |
          ssh -i ~/.ssh/deploy_key \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "DEPLOY_PATH='${{ env.DEPLOY_PATH }}' bash -se" << 'ENDSSH'
          set -euo pipefail

          cd "$DEPLOY_PATH"

          if [ ! -d .git ]; then
            echo "ERROR: $DEPLOY_PATH is not a git repo. Clone it first."
            exit 1
          fi

          git fetch --all
          git reset --hard origin/main

          cd infra
          docker compose -f docker-compose.prod.yml --env-file .env down --remove-orphans || true
          docker compose -f docker-compose.prod.yml --env-file .env up -d --build

          docker compose -f docker-compose.yml exec -T backend node dist/scripts/migrate.js || true
          docker image prune -f
          docker compose -f docker-compose.yml ps
          ENDSSH

      - name: Health check
        run: |
          sleep 10
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "curl -fsS http://localhost:3000/api/health"
